name: Extract CloudDrive Android Resources

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'CloudDrive version to extract (leave empty for latest)'
        required: false
        default: ''
  schedule:
    # Run every day at 00:00 UTC to check for new releases
    - cron: '0 0 * * *'

permissions:
  contents: write
  
jobs:
  extract-resources:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '8.0.x'

    - name: Install ILSpy CLI
      run: |
        dotnet tool install --global ilspycmd
        echo "ILSpy CLI installed successfully"
        ilspycmd --version

    - name: Get latest release info
      id: get-release
      run: |
        if [ -n "${{ github.event.inputs.version }}" ]; then
          VERSION="${{ github.event.inputs.version }}"
          echo "Using specified version: $VERSION"
        else
          # Get latest release version from GitHub API
          VERSION=$(curl -s https://api.github.com/repos/cloud-fs/cloud-fs.github.io/releases/latest | jq -r '.tag_name')
          echo "Latest version found: $VERSION"
        fi
        
        # Remove 'v' prefix if present
        VERSION_NUMBER=$(echo $VERSION | sed 's/^v//')
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=$VERSION_NUMBER" >> $GITHUB_OUTPUT
        echo "download_url=https://github.com/cloud-fs/cloud-fs.github.io/releases/download/$VERSION/clouddrive-2-android-x86_64-$VERSION_NUMBER.tgz" >> $GITHUB_OUTPUT

    - name: Download and extract CloudDrive release
      run: |
        echo "Downloading from: ${{ steps.get-release.outputs.download_url }}"
        
        # Create working directory
        mkdir -p work
        cd work
        
        # Download the release file
        curl -L -o clouddrive-android.tgz "${{ steps.get-release.outputs.download_url }}"
        
        # Extract the archive
        tar -xzf clouddrive-android.tgz
        
        # List contents to verify structure
        echo "Archive contents:"
        find . -name "*.dll" -type f | head -10
        
        # Find the actual directory structure
        EXTRACT_DIR=$(find . -name "CloudDriveModern.dll" -type f | head -1 | xargs dirname)
        echo "Found CloudDriveModern.dll in: $EXTRACT_DIR"
        
        # Create symbolic links for easier access
        if [ -n "$EXTRACT_DIR" ]; then
          ln -sf "$EXTRACT_DIR" framework
          echo "Created symlink: framework -> $EXTRACT_DIR"
        else
          echo "Error: CloudDriveModern.dll not found in archive"
          exit 1
        fi
        
        # Verify required files exist
        if [ ! -f "framework/CloudDriveModern.dll" ]; then
          echo "Error: CloudDriveModern.dll not found"
          exit 1
        fi
        
        if [ ! -f "framework/zh-CN/CloudDriveModern.resources.dll" ]; then
          echo "Error: CloudDriveModern.resources.dll not found"
          exit 1
        fi
        
        echo "Required DLL files found successfully"

    - name: Decompile DLL files
      run: |
        cd work
        
        # Create decompile directories
        mkdir -p decompile-en decompile-zh
        
        echo "Decompiling English resources..."
        ilspycmd -p -o ./decompile-en framework/CloudDriveModern.dll
        
        echo "Decompiling Chinese resources..."
        ilspycmd -p -o ./decompile-zh framework/zh-CN/CloudDriveModern.resources.dll
        
        # List decompiled files to debug
        echo "Decompiled English files:"
        find decompile-en -name "*.resx" || echo "No .resx files found in English decompile"
        
        echo "Decompiled Chinese files:"
        find decompile-zh -name "*.resx" || echo "No .resx files found in Chinese decompile"
        
        # Verify decompiled files exist
        if [ ! -f "decompile-en/CloudDriveModern.Resources.SharedResources.resx" ]; then
          echo "Error: English resources not found after decompilation"
          echo "Available files in decompile-en:"
          find decompile-en -type f | head -10
          exit 1
        fi
        
        if [ ! -f "decompile-zh/CloudDriveModern.Resources.SharedResources.zh-CN.resx" ]; then
          echo "Error: Chinese resources not found after decompilation"
          echo "Available files in decompile-zh:"
          find decompile-zh -type f | head -10
          exit 1
        fi
        
        echo "Decompilation completed successfully"

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Convert resources to Android XML
      run: |
        cd work
        
        # Create the conversion script with field completion functionality
        cat > convert_resources.py << 'EOF'
        import xml.etree.ElementTree as ET
        import os
        import zipfile
        from pathlib import Path

        def parse_resx_file(resx_file):
            """Parse .resx file and return a dictionary of name-value pairs"""
            try:
                tree = ET.parse(resx_file)
                root = tree.getroot()
                
                data_dict = {}
                for data in root.findall('.//data[@name]'):
                    name_attr = data.get('name')
                    value_elem = data.find('value')
                    
                    if name_attr and value_elem is not None and value_elem.text:
                        data_dict[name_attr] = value_elem.text.strip()
                
                return data_dict
                
            except Exception as e:
                print(f"Error parsing {resx_file}: {e}")
                return {}

        def create_android_xml(data_dict, output_file, prefix="cd2_locale_"):
            """Create Android strings.xml from data dictionary"""
            try:
                resources = ET.Element("resources")
                
                for name, value in data_dict.items():
                    string_elem = ET.SubElement(resources, "string")
                    string_elem.set("name", f"{prefix}{name}")
                    string_elem.text = value
                
                # Write to file with proper XML formatting
                tree_out = ET.ElementTree(resources)
                ET.indent(tree_out, space="  ", level=0)
                tree_out.write(output_file, encoding='utf-8', xml_declaration=True)
                
                print(f"Created Android XML: {output_file}")
                return True
                
            except Exception as e:
                print(f"Error creating Android XML {output_file}: {e}")
                return False

        def complete_missing_fields(en_data, zh_data):
            """Ensure both language dictionaries have the same keys"""
            all_keys = set(en_data.keys()) | set(zh_data.keys())
            
            # Fill missing fields in English with field names
            for key in all_keys:
                if key not in en_data:
                    en_data[key] = key
            
            # Fill missing fields in Chinese with field names
            for key in all_keys:
                if key not in zh_data:
                    zh_data[key] = key
            
            return en_data, zh_data, len(all_keys)

        def main():
            # File paths
            en_resx = "decompile-en/CloudDriveModern.Resources.SharedResources.resx"
            zh_resx = "decompile-zh/CloudDriveModern.Resources.SharedResources.zh-CN.resx"
            
            # Parse both resource files
            en_data = parse_resx_file(en_resx)
            zh_data = parse_resx_file(zh_resx)
            
            print(f"English original keys: {len(en_data)}")
            print(f"Chinese original keys: {len(zh_data)}")
            
            # Complete missing fields
            en_completed, zh_completed, total_keys = complete_missing_fields(en_data, zh_data)
            
            # Create output directories
            os.makedirs("android-resources/values", exist_ok=True)
            os.makedirs("android-resources/values-zh", exist_ok=True)
            
            # Create Android XML files
            success_en = create_android_xml(
                en_completed, 
                "android-resources/values/cd2.xml"
            )
            
            success_zh = create_android_xml(
                zh_completed, 
                "android-resources/values-zh/cd2.xml"
            )
            
            if not success_en or not success_zh:
                exit(1)
            
            # Create ZIP file
            with zipfile.ZipFile("clouddrive-android-resources.zip", 'w') as zip_file:
                zip_file.write("android-resources/values/cd2.xml", "values/cd2.xml")
                zip_file.write("android-resources/values-zh/cd2.xml", "values-zh/cd2.xml")
            
            print("Created clouddrive-android-resources.zip successfully")
            
            # Print detailed statistics
            missing_in_en = [key for key in zh_completed.keys() if key not in en_data]
            missing_in_zh = [key for key in en_completed.keys() if key not in zh_data]
            
            print(f"\n=== ç»Ÿè®¡ä¿¡æ¯ ===")
            print(f"æ€»å­—ç¬¦ä¸²æ•°: {total_keys} ä¸ª")
            print(f"è‹±æ–‡åŽŸæœ‰: {len(en_data)} ä¸ªï¼Œè¡¥é½: {len(missing_in_en)} ä¸ª")
            print(f"ä¸­æ–‡åŽŸæœ‰: {len(zh_data)} ä¸ªï¼Œè¡¥é½: {len(missing_in_zh)} ä¸ª")
            
            if missing_in_en:
                print(f"\nè‹±æ–‡ä¸­ç¼ºå¤±çš„å­—æ®µ (å·²ç”¨å­—æ®µåè¡¥é½):")
                for i, key in enumerate(missing_in_en[:5]):  # Show first 5 as example
                    print(f"  - {key}")
                if len(missing_in_en) > 5:
                    print(f"  ... è¿˜æœ‰ {len(missing_in_en) - 5} ä¸ª")
            
            if missing_in_zh:
                print(f"\nä¸­æ–‡ä¸­ç¼ºå¤±çš„å­—æ®µ (å·²ç”¨å­—æ®µåè¡¥é½):")
                for i, key in enumerate(missing_in_zh[:5]):  # Show first 5 as example
                    print(f"  - {key}")
                if len(missing_in_zh) > 5:
                    print(f"  ... è¿˜æœ‰ {len(missing_in_zh) - 5} ä¸ª")
            
            # Output final stats for GitHub Actions to capture
            print(f"\nFINAL_STATS:")
            print(f"TOTAL_KEYS:{total_keys}")
            print(f"EN_ORIGINAL:{len(en_data)}")
            print(f"ZH_ORIGINAL:{len(zh_data)}")
            print(f"MISSING_EN:{len(missing_in_en)}")
            print(f"MISSING_ZH:{len(missing_in_zh)}")

        if __name__ == "__main__":
            main()
        EOF
        
        # Run the conversion script
        python convert_resources.py

    - name: Verify generated files
      run: |
        cd work
        
        # Check if files were generated
        if [ ! -f "clouddrive-android-resources.zip" ]; then
          echo "Error: ZIP file not created"
          exit 1
        fi
        
        # Extract and verify ZIP contents
        unzip -l clouddrive-android-resources.zip
        
        # Show sample content from generated files
        echo "=== Sample English XML content ==="
        head -20 android-resources/values/cd2.xml
        
        echo "=== Sample Chinese XML content ==="
        head -20 android-resources/values-zh/cd2.xml
        
        # Verify both files have the same number of string elements
        echo "=== Verification: Checking string counts ==="
        en_count=$(grep -c '<string name=' android-resources/values/cd2.xml)
        zh_count=$(grep -c '<string name=' android-resources/values-zh/cd2.xml)
        
        echo "English strings count: $en_count"
        echo "Chinese strings count: $zh_count"
        
        if [ "$en_count" -eq "$zh_count" ]; then
          echo "âœ“ SUCCESS: Both language files have the same number of strings"
        else
          echo "âœ— ERROR: String counts don't match: English=$en_count, Chinese=$zh_count"
          exit 1
        fi

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: clouddrive-android-resources-${{ steps.get-release.outputs.version_number }}
        path: work/clouddrive-android-resources.zip
        retention-days: 30

    - name: Create Release (if new version)
      if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        cd work
        
        # Extract statistics from the conversion output
        STATS_FILE="conversion_stats.txt"
        
        # Run conversion again to capture statistics
        python convert_resources.py > $STATS_FILE 2>&1
        
        # Extract key statistics using the FINAL_STATS format
        TOTAL_KEYS=$(grep "TOTAL_KEYS:" $STATS_FILE | cut -d':' -f2)
        EN_ORIGINAL=$(grep "EN_ORIGINAL:" $STATS_FILE | cut -d':' -f2)
        ZH_ORIGINAL=$(grep "ZH_ORIGINAL:" $STATS_FILE | cut -d':' -f2)
        MISSING_EN=$(grep "MISSING_EN:" $STATS_FILE | cut -d':' -f2)
        MISSING_ZH=$(grep "MISSING_ZH:" $STATS_FILE | cut -d':' -f2)
        
        # Create simplified release notes with statistics
        cat > release_notes.md << EOF
        # CloudDrive Android èµ„æºæ–‡ä»¶ v${{ steps.get-release.outputs.version_number }}
        
        ä»Ž CloudDrive ${{ steps.get-release.outputs.version }} è‡ªåŠ¨ç”Ÿæˆçš„ Android XML èµ„æºæ–‡ä»¶
        
        ## ðŸ“Š ç»Ÿè®¡ä¿¡æ¯
        - **æ€»å­—ç¬¦ä¸²æ•°**: ${TOTAL_KEYS:-"N/A"} ä¸ª
        - **è‹±æ–‡åŽŸæœ‰**: ${EN_ORIGINAL:-"N/A"} ä¸ªï¼Œ**è¡¥é½**: ${MISSING_EN:-"0"} ä¸ª
        - **ä¸­æ–‡åŽŸæœ‰**: ${ZH_ORIGINAL:-"N/A"} ä¸ªï¼Œ**è¡¥é½**: ${MISSING_ZH:-"0"} ä¸ª
        
        > ä¸¤ä¸ªè¯­è¨€æ–‡ä»¶åŒ…å«å®Œå…¨ç›¸åŒçš„å­—ç¬¦ä¸²é”®ã€‚ç¼ºå¤±çš„ç¿»è¯‘å·²è‡ªåŠ¨ç”¨é”®åå¡«å……ã€‚
        EOF
        
        # Check if this version already has a release
        RELEASE_TAG="android-resources-${{ steps.get-release.outputs.version_number }}"
        
        if gh release view $RELEASE_TAG >/dev/null 2>&1; then
          echo "Release $RELEASE_TAG already exists, updating assets and notes..."
          gh release edit $RELEASE_TAG \
            --notes-file release_notes.md
          gh release upload $RELEASE_TAG clouddrive-android-resources.zip --clobber
        else
          echo "Creating new release $RELEASE_TAG..."
          gh release create $RELEASE_TAG \
            --title "CloudDrive Android Resources ${{ steps.get-release.outputs.version_number }}" \
            --notes-file release_notes.md \
            clouddrive-android-resources.zip
        fi
        
        echo "Release notes:"
        cat release_notes.md
